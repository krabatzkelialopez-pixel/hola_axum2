<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Admin - Mensajes | Axum Motors</title>
    <link rel="stylesheet" href="/css/styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body class="admin-layout">

    <aside class="sidebar">
        <h2>AXUM MOTORS ADMIN</h2>
        <nav>
            <ul>
                <li><a href="/">ğŸŒ Ver Sitio Web</a></li>
                <li><a href="#" class="active">ğŸ“© Mensajes</a></li>
                <li><a href="#">ğŸï¸ Inventario</a></li>
                <li><a href="#">ğŸ“¸ GalerÃ­a</a></li>
            </ul>
        </nav>
    </aside>

    <main class="admin-main">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h2>GestiÃ³n de Mensajes</h2>
            
            <div class="search-container">
                <input type="text" id="adminSearch" placeholder="ğŸ” Buscar por nombre o mensaje..." 
                       style="width: 350px; padding: 12px; border-radius: 25px; border: 1px solid #ddd; outline: none;">
            </div>
        </header>

        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: var(--shadow); overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Mensaje</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="admin-table-body">
                    </tbody>
            </table>
            
            <div id="pagination-controls" class="pagination"></div>
        </div>
    </main>

    <script>
        let allMessages = [];
        let filteredMessages = [];
        let currentPage = 1;
        const recordsPerPage = 10; // Cantidad de registros por pÃ¡gina

        // Cargar mensajes desde el backend Rust
        async function loadAllData() {
            const res = await fetch("/mensajes");
            if (res.ok) {
                allMessages = await res.json();
                filteredMessages = [...allMessages];
                renderTable();
            }
        }

        // Renderizar la tabla con paginaciÃ³n
        function renderTable() {
            const tbody = document.getElementById("admin-table-body");
            tbody.innerHTML = "";

            const start = (currentPage - 1) * recordsPerPage;
            const end = start + recordsPerPage;
            const pageItems = filteredMessages.slice(start, end);

            if (pageItems.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>No se encontraron resultados</td></tr>";
            }

            pageItems.forEach(m => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${m.id}</td>
                    <td><strong>${m.nombre}</strong></td>
                    <td>${m.mensaje}</td>
                    <td>
                        <button onclick="editarMensaje(${m.id}, '${m.nombre}', '${m.mensaje}')" 
                                style="background:var(--accent); color:white; border-radius:4px; padding:6px 10px; margin-right:5px;">âœï¸</button>
                        <button onclick="eliminarMensaje(${m.id})" 
                                style="background:#c0392b; color:white; border-radius:4px; padding:6px 10px;">ğŸ—‘</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            renderPaginationControls();
        }

        // Crear botones de paginaciÃ³n
        function renderPaginationControls() {
            const totalPages = Math.ceil(filteredMessages.length / recordsPerPage);
            const container = document.getElementById("pagination-controls");
            container.innerHTML = "";

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement("button");
                btn.innerText = i;
                if (i === currentPage) btn.classList.add("active");
                btn.onclick = () => {
                    currentPage = i;
                    renderTable();
                    window.scrollTo(0,0);
                };
                container.appendChild(btn);
            }
        }

        // LÃ³gica de bÃºsqueda en tiempo real
        document.getElementById("adminSearch").addEventListener("input", (e) => {
            const term = e.target.value.toLowerCase();
            filteredMessages = allMessages.filter(m => 
                m.nombre.toLowerCase().includes(term) || 
                m.mensaje.toLowerCase().includes(term)
            );
            currentPage = 1; 
            renderTable();
        });

        // Funciones CRUD (usando tus rutas de Axum)
        async function eliminarMensaje(id) {
            if (!confirm("Â¿Eliminar este mensaje?")) return;
            const res = await fetch(`/mensajes/${id}`, { method: "DELETE" });
            if (res.ok) loadAllData();
            else alert("Error al eliminar");
        }

        async function editarMensaje(id, nombre, mensaje) {
            const n = prompt("Nuevo nombre:", nombre);
            const m = prompt("Nuevo mensaje:", mensaje);
            if (!n || !m) return;

            const formData = new URLSearchParams();
            formData.append("nombre", n);
            formData.append("mensaje", m);

            const res = await fetch(`/mensajes/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: formData
            });

            if (res.ok) loadAllData();
            else alert("Error al actualizar");
        }

        loadAllData();
    </script>
</body>
</html>