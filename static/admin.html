<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin | Axum Motors</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

<div class="sidebar">
    <h2>Axum Motors</h2>
    <a href="/index.html">ğŸ  Inicio</a>
    <a href="/motos.html">ğŸ Motos</a>
    <a href="/otros.html">ğŸš² Otros</a>
    <a href="/contacto.html">âœ‰ï¸ Contacto</a>
    <a href="/admin.html" class="active">ğŸ“‹ Admin</a>
</div>

<div class="main-content">
    <div class="page-title">Panel de AdministraciÃ³n</div>
    
    <div class="admin-tools">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Buscar por nombre..." onkeyup="filtrarTabla()">
        </div>
        <button class="btn-create" onclick="window.location.href='/contacto.html'">
            <span>+</span> Nuevo Registro
        </button>
    </div>

    <div class="table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Mensaje</th>
                    <th style="text-align: center;">Acciones</th>
                </tr>
            </thead>
            <tbody id="mensajes-table"></tbody>
        </table>

        <div class="pagination">
            <button id="btnPrev" onclick="cambiarPagina(-1)">Anterior</button>
            <span id="pageInfo"></span>
            <button id="btnNext" onclick="cambiarPagina(1)">Siguiente</button>
        </div>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>Editar Mensaje</h3>
        <form id="editForm">
            <input type="hidden" id="editId">
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="editNombre" required>
            </div>
            <div class="form-group">
                <label>Mensaje:</label>
                <textarea id="editMensaje" rows="4" required></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

<script>
let mensajesData = [];
let datosFiltrados = [];
let paginaActual = 1;
const registrosPorPagina = 5;

async function cargarMensajes() {
    const res = await fetch("/mensajes");
    mensajesData = await res.json();
    datosFiltrados = [...mensajesData];
    renderizarTabla();
}

function renderizarTabla() {
    const tbody = document.getElementById("mensajes-table");
    tbody.innerHTML = "";

    const inicio = (paginaActual - 1) * registrosPorPagina;
    const fin = inicio + registrosPorPagina;
    const paginados = datosFiltrados.slice(inicio, fin);

    paginados.forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="id-cell">#${m.id}</td>
            <td class="name-cell">${m.nombre}</td>
            <td class="msg-cell">${m.mensaje}</td>
            <td class="actions-cell">
                <div style="display:flex; gap:5px; justify-content:center;">
                    <button class="btn-edit" onclick="abrirModal(${m.id}, '${m.nombre}', '${m.mensaje}')">âœï¸</button>
                    <button class="btn-delete" onclick="eliminarMensaje(${m.id})">ğŸ—‘</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
    actualizarControles();
}

// --- LÃ“GICA DEL MODAL ---
function abrirModal(id, nombre, mensaje) {
    document.getElementById("editId").value = id;
    document.getElementById("editNombre").value = nombre;
    document.getElementById("editMensaje").value = mensaje;
    document.getElementById("editModal").style.display = "flex";
}

function cerrarModal() {
    document.getElementById("editModal").style.display = "none";
}

document.getElementById("editForm").onsubmit = async (e) => {
    e.preventDefault();
    const id = document.getElementById("editId").value;
    
    // Usamos URLSearchParams para enviar como Form Data (como espera tu Rust)
    const formData = new URLSearchParams();
    formData.append("nombre", document.getElementById("editNombre").value);
    formData.append("mensaje", document.getElementById("editMensaje").value);

    const res = await fetch(`/mensajes/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData
    });

    if (res.ok) {
        cerrarModal();
        cargarMensajes();
    } else {
        alert("Error al actualizar");
    }
};

// --- RESTO DE FUNCIONES (Paginado/Eliminar/etc) ---
function actualizarControles() {
    const totalPaginas = Math.ceil(datosFiltrados.length / registrosPorPagina) || 1;
    document.getElementById("pageInfo").innerText = `PÃ¡gina ${paginaActual} de ${totalPaginas}`;
    document.getElementById("btnPrev").disabled = paginaActual === 1;
    document.getElementById("btnNext").disabled = paginaActual === totalPaginas;
}

function cambiarPagina(dir) { paginaActual += dir; renderizarTabla(); }

function filtrarTabla() {
    const bus = document.getElementById("searchInput").value.toLowerCase();
    datosFiltrados = mensajesData.filter(m => m.nombre.toLowerCase().includes(bus) || m.mensaje.toLowerCase().includes(bus));
    paginaActual = 1;
    renderizarTabla();
}

async function eliminarMensaje(id) {
    if (!confirm("Â¿Eliminar?")) return;
    await fetch(`/mensajes/${id}`, { method: "DELETE" });
    cargarMensajes();
}

cargarMensajes();
</script>

</body>
</html>